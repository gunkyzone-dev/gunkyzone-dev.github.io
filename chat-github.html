<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <title>GunkyZone - LIVE_COMMS</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #020202; --bg2: #080505; --border: #2a0000;
      --text: #d4c0c0; --accent: #ff0000; --accent2: #9b0000;
      --font-mono: 'VT323', monospace;
    }
    body {
      background: var(--bg); color: var(--text); font-family: var(--font-mono);
      font-size: 19px; padding: 10px; line-height: 1.2; overflow: hidden;
      animation: terminalOn 0.4s ease-out forwards;
    }
    @keyframes terminalOn {
      0% { opacity: 0; transform: scaleY(0.95) scaleX(0.95); filter: brightness(3) contrast(2); }
      20% { opacity: 1; transform: scaleY(1.02) scaleX(1.02); filter: brightness(1.5) contrast(1.5); }
      40% { opacity: 0.8; transform: scaleY(0.98) scaleX(0.98); filter: brightness(1.2); }
      60% { opacity: 1; transform: scaleY(1.01) scaleX(1.01); filter: brightness(1.1); }
      80% { opacity: 0.9; transform: scaleY(0.99) scaleX(0.99); filter: brightness(1.05); }
      100% { opacity: 1; transform: scaleY(1) scaleX(1); filter: brightness(1) contrast(1); }
    }
    #chat-container { display: flex; flex-direction: column; height: 95vh; }
    #messages-container {
      flex-grow: 1; overflow-y: auto; border: 1px solid var(--border);
      background: #000; padding: 10px; margin-bottom: 10px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .msg { border-bottom: 1px solid #1a0000; padding-bottom: 4px; animation: scanIn 0.2s ease-out; }
    .msg-author { font-weight: bold; text-transform: uppercase; margin-right: 8px; }
    .input-wrap { display: flex; gap: 5px; border: 1px solid var(--border); background: var(--bg2); padding: 5px; align-items: center; }
    input {
      background: transparent; border: none; color: #fff; 
      padding: 8px; font-family: var(--font-mono); font-size: 18px; outline: none; flex-grow: 1;
    }
    #name-input { width: 80px; border-right: 1px solid var(--border); color: var(--accent2); text-align: center; }
    #messages-container::-webkit-scrollbar { width: 6px; }
    #messages-container::-webkit-scrollbar-thumb { background: var(--accent2); }
    @keyframes scanIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
    
    #settings-btn {
      background: transparent; border: 1px solid var(--border); color: var(--accent2);
      padding: 8px 12px; cursor: pointer; font-family: var(--font-mono); font-size: 16px;
    }
    #settings-btn:hover { background: var(--bg2); }
    
    #settings-panel {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--bg); border: 2px solid var(--accent); padding: 20px;
      z-index: 1000; min-width: 300px; display: none;
    }
    
    .setting-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; gap: 10px;
    }
    
    .setting-row label { color: var(--text); min-width: 80px; }
    
    #color-picker {
      width: 60px; height: 30px; border: 1px solid var(--border);
      background: transparent; cursor: pointer;
    }
    
    #style-select {
      background: var(--bg2); border: 1px solid var(--border); color: var(--text);
      padding: 5px; font-family: var(--font-mono);
    }
    
    #close-settings {
      background: var(--accent); color: #fff; border: none; padding: 8px 16px;
      cursor: pointer; font-family: var(--font-mono); margin-top: 10px;
    }
    
    #settings-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 999; display: none;
    }

    #back-btn {
      display: none; /* Hidden by default, shown via JS if not in iframe */
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: var(--bg2); border: 1px solid var(--border); color: var(--accent2);
      padding: 5px 15px; cursor: pointer; font-family: var(--font-mono); font-size: 16px;
      text-decoration: none; text-transform: uppercase;
    }
    #back-btn:hover { color: #fff; background: var(--accent2); animation: jitter 0.2s infinite; text-shadow: 2px 0 var(--accent), -2px 0 #00ffff; }
    @keyframes jitter { 0% { transform: translate(2px, -1px); } 50% { transform: translate(-1px, 1px); } }
  </style>
</head>
<body>

<a href="index.html" id="back-btn">< RETURN</a>

<div id="chat-container">
  <div id="messages-container">
    <div class="msg"><span class="msg-author">SYSTEM:</span> ESTABLISHING_LINK...</div>
  </div>

  <div class="input-wrap">
    <input type="text" id="name-input" placeholder="ANON" maxlength="10">
    <input type="text" id="chat-input" placeholder="ENTER MESSAGE..." autocomplete="off">
    <button id="settings-btn">âš™</button>
  </div>
</div>

<div id="settings-overlay"></div>
<div id="settings-panel">
  <div class="setting-row">
    <label>Name:</label>
    <input type="text" id="settings-name" maxlength="10" style="background: var(--bg2); border: 1px solid var(--border); color: var(--text); padding: 5px; font-family: var(--font-mono);">
  </div>
  <div class="setting-row">
    <label>Color:</label>
    <input type="color" id="color-picker" value="#ff0000">
  </div>
  <div class="setting-row">
    <label>Style:</label>
    <select id="style-select">
      <option value="normal">Normal</option>
      <option value="bold">Bold</option>
      <option value="italic">Italic</option>
    </select>
  </div>
  <button id="close-settings">CLOSE</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD1L4Mmgnbl0W7lk1rnaRu5wv61TSFhJqM",
    authDomain: "gunkychat.firebaseapp.com",
    databaseURL: "https://gunkychat-default-rtdb.firebaseio.com",
    projectId: "gunkychat",
    storageBucket: "gunkychat.firebasestorage.app",
    messagingSenderId: "423489767287",
    appId: "1:423489767287:web:ce847768781b0f589dc372"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database().ref('gunky_chat');
  const msgContainer = document.getElementById('messages-container');
  const chatInput = document.getElementById('chat-input');
  const nameInput = document.getElementById('name-input');

  // Check if we are in an iframe via query param
  const urlParams = new URLSearchParams(window.location.search);
  if (!urlParams.has('iframe')) {
    // Not in an iframe, show the back button
    document.getElementById('back-btn').style.display = 'inline-block';
    // Add some top padding to the chat container so it doesn't overlap the button
    document.getElementById('chat-container').style.paddingTop = '40px';
  }

  let userSettings = {
    name: localStorage.getItem('chat-name') || 'ANON',
    color: localStorage.getItem('chat-color') || '#ff0000',
    style: localStorage.getItem('chat-style') || 'normal'
  };

  nameInput.value = userSettings.name;
  document.getElementById('settings-name').value = userSettings.name;
  document.getElementById('color-picker').value = userSettings.color;
  document.getElementById('style-select').value = userSettings.style;

  const settingsBtn = document.getElementById('settings-btn');
  const settingsPanel = document.getElementById('settings-panel');
  const settingsOverlay = document.getElementById('settings-overlay');
  const closeSettings = document.getElementById('close-settings');

  settingsBtn.addEventListener('click', () => {
    settingsPanel.style.display = 'block';
    settingsOverlay.style.display = 'block';
  });

  closeSettings.addEventListener('click', () => {
    settingsPanel.style.display = 'none';
    settingsOverlay.style.display = 'none';
    
    userSettings.name = document.getElementById('settings-name').value || 'ANON';
    userSettings.color = document.getElementById('color-picker').value;
    userSettings.style = document.getElementById('style-select').value;
    
    localStorage.setItem('chat-name', userSettings.name);
    localStorage.setItem('chat-color', userSettings.color);
    localStorage.setItem('chat-style', userSettings.style);
    
    nameInput.value = userSettings.name;
  });

  settingsOverlay.addEventListener('click', () => {
    closeSettings.click();
  });

  db.limitToLast(50).on('value', (snapshot) => {
    msgContainer.innerHTML = ""; 
    snapshot.forEach((child) => {
      const data = child.val();
      const div = document.createElement('div');
      div.className = 'msg';
      
      const authorSpan = document.createElement('span');
      authorSpan.className = 'msg-author';
      authorSpan.textContent = (data.author || 'ANON') + ':';
      authorSpan.style.color = data.color || '#ff0000';
      
      const textSpan = document.createElement('span');
      textSpan.textContent = data.text || '';
      if (data.style === 'bold') textSpan.style.fontWeight = 'bold';
      if (data.style === 'italic') textSpan.style.fontStyle = 'italic';
      
      div.appendChild(authorSpan);
      div.appendChild(textSpan);
      msgContainer.appendChild(div);
    });
    msgContainer.scrollTop = msgContainer.scrollHeight;
  });

  function sendMessage() {
    const text = chatInput.value.trim();
    if (text !== "") {
      db.push({
        author: userSettings.name,
        text: text,
        color: userSettings.color,
        style: userSettings.style,
        timestamp: Date.now()
      });
      chatInput.value = "";
    }
  }

  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
</body>
</html>
