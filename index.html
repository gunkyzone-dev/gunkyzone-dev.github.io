<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GunkyZone - TERMINAL_v1.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #020202; --bg2: #080505; --border: #2a0000; --dim: #5a3a3a;
      --text: #d4c0c0; --accent: #ff0000; --accent2: #9b0000; --glow: rgba(255, 0, 0, 0.3);
      --font-mono: 'VT323', monospace;
    }
    html { background: #000; overflow-x: hidden; }
    body {
      background: var(--bg); color: var(--text); font-family: var(--font-mono); font-size: 19px;
      letter-spacing: 1px; line-height: 1.4; min-height: 100vh;
      animation: crtBoot 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      text-shadow: 0 0 2px rgba(212, 192, 192, 0.2);
    }
    @keyframes crtBoot {
      0% { transform: scaleY(0.005) scaleX(0); filter: brightness(10); opacity: 0; }
      10% { transform: scaleY(0.005) scaleX(1); filter: brightness(10); opacity: 1; }
      40% { transform: scaleY(1) scaleX(1.1); filter: brightness(2); }
ca      100% { transform: none; filter: none; opacity: 1; }
    }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 1000;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, rgba(0,0,0,0.2) 2px, rgba(0,0,0,0.2) 4px);
      animation: flicker 0.1s infinite;
    }
    @keyframes flicker { 0% { opacity: 0.95; } 100% { opacity: 0.97; } }
    body::after {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 999;
      background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
    }
    .site-wrapper { max-width: 900px; margin: 0 auto; padding: 0 20px; }
    header { border-bottom: 2px solid var(--border); padding: 40px 0 20px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; }
    .header-tag { font-size: 14px; color: var(--accent2); }
    #user-count { font-size: 14px; color: var(--accent); letter-spacing: 1px; }

    .site-title { font-size: 80px; line-height: 0.9; color: var(--accent); text-shadow: 0 0 15px var(--glow); }
    .site-title span.zone-text { color: #fff; text-shadow: 0 0 10px #fff; transition: text-shadow 0.5s, color 0.5s; }
    .site-title span.zone-glow { text-shadow: 0 0 30px #fff, 0 0 50px var(--accent); color: #fff; }
    .cursor { display: inline-block; width: 12px; height: 1.1em; background: var(--accent); vertical-align: middle; animation: blink 0.8s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    nav { display: flex; margin-top: 30px; gap: 5px; }
    nav a { padding: 5px 15px; color: var(--dim); border: 1px solid var(--border); text-transform: uppercase; text-decoration: none; }
    nav a:hover { color: #fff; background: var(--accent2); animation: jitter 0.2s infinite; text-shadow: 2px 0 var(--accent), -2px 0 #00ffff; }
    @keyframes jitter { 0% { transform: translate(2px, -1px); } 50% { transform: translate(-1px, 1px); } }
    .welcome-box { border: 1px solid var(--border); padding: 20px; background: var(--bg2); margin: 30px 0; min-height: 60px; }
    .section-label { color: var(--accent2); font-size: 14px; margin: 40px 0 10px; border-bottom: 1px solid var(--border); }
    
    /* Drawings Grid */
    .drawing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    .drawing-item { border: 1px solid var(--border); background: #050000; padding: 10px; cursor: pointer; display: flex; gap: 10px; align-items: center; transition: 0.2s; }
    .drawing-item:hover { border-color: var(--accent); background: #1a0000; }
    .drawing-thumb { width: 60px; height: 60px; background: #000; border: 1px solid #222; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .drawing-thumb img { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* Compact Comics List */
    .compact-list { display: flex; flex-direction: column; gap: 8px; }
    .compact-item { border: 1px solid var(--border); background: #050000; padding: 8px 12px; cursor: pointer; display: flex; gap: 15px; align-items: center; transition: 0.2s; }
    .compact-item:hover { border-color: var(--accent); background: #1a0000; }
    .compact-thumb { width: 30px; height: 40px; background: #111; border: 1px solid #222; flex-shrink: 0; }
    .compact-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .compact-info { display: flex; justify-content: space-between; width: 100%; align-items: center; }

    /* NEW badge */
    .new-badge { display: inline-block; background: var(--accent); color: #fff; font-size: 11px; padding: 0 5px; margin-left: 6px; vertical-align: middle; animation: blink 1s step-end infinite; }
    /* Visit counter */
    #visit-count { font-size: 14px; color: var(--dim); letter-spacing: 1px; }
    /* Transmission of the day */
    .transmission-box { border: 1px solid var(--accent2); padding: 12px 20px; background: #050000; margin: 15px 0 30px 0; color: var(--accent); font-size: 17px; }
    .transmission-box::before { content: '// TRANSMISSION_OF_THE_DAY'; display: block; font-size: 12px; color: var(--accent2); margin-bottom: 6px; }
    /* Guestbook */
    .guestbook-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .guestbook-form input, .guestbook-form textarea { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px 10px; font-family: var(--font-mono); font-size: 17px; resize: vertical; }
    .guestbook-form button { background: var(--accent2); color: #fff; border: none; padding: 8px 20px; font-family: var(--font-mono); font-size: 17px; cursor: pointer; text-transform: uppercase; }
    .guestbook-form button:hover { background: var(--accent); }
    .guestbook-entry { border-bottom: 1px solid #1a0000; padding: 10px 0; }
    .guestbook-entry .gb-name { color: var(--accent); font-size: 15px; }
    .guestbook-entry .gb-msg { color: var(--text); font-size: 17px; margin-top: 2px; word-break: break-word; }
    .guestbook-entry .gb-time { font-size: 12px; color: var(--dim); margin-top: 2px; }

    footer { padding: 40px 0; border-top: 1px solid var(--border); color: var(--dim); font-size: 14px; }
  </style>
</head>
<body>
<div class="site-wrapper">
  <header>
    <div class="header-row">
      <div class="header-tag">SYS_STATUS: ONLINE // EST. 2025</div>
      <div style="display:flex; gap:15px; align-items:center;">
        <div id="visit-count">VISITS: —</div>
        <div id="user-count">USERS_ONLINE: 0</div>
      </div>
    </div>
    <h1 class="site-title"><span id="type-gunky"></span><span id="type-zone" class="zone-text"></span><span id="title-cursor" class="cursor"></span></h1>
    <p id="type-subtitle" style="color: var(--dim); min-height: 1.2em;"></p>
    <nav>
      <a href="index.html">HOME</a>
      <a href="comics.html">COMICS</a>
      <a href="drawings.html">DRAWINGS</a>
      <a href="chat-github.html">CHAT</a>
    </nav>
  </header>

  <main>
    <div class="welcome-box">
      <span id="type-welcome"></span><span id="welcome-cursor" class="cursor" style="display:none;"></span>
    </div>

    <div id="daily-transmission" class="transmission-box">LOADING_SIGNAL...</div>

    <div class="section-label">> LATEST_ENTRIES</div>
    <div id="recent-entries" class="recent-grid">LOADING_DATA...</div>

    <div class="section-label">> LIVE_COMMS</div>
    <div style="border: 1px solid var(--border); background: #000;">
      <iframe src="chat-github.html?iframe=true" style="width:100%; height:400px; border:none;"></iframe>
    </div>

    <div class="section-label">> GUESTBOOK</div>
    <div style="border: 1px solid var(--border); background: var(--bg2); padding: 20px;">
      <div class="guestbook-form">
        <input type="text" id="gb-name" placeholder="CALLSIGN_HERE" maxlength="30">
        <textarea id="gb-msg" placeholder="LEAVE_A_TRANSMISSION..." maxlength="300" rows="3"></textarea>
        <button onclick="submitGuestbook()">[ TRANSMIT ]</button>
      </div>
      <div id="guestbook-entries">LOADING_LOGS...</div>
    </div>

    <div class="section-label">> LATEST_COMICS</div>
    <div id="recent-comics" class="recent-grid">LOADING_DATA...</div>
  </main>

  <footer>
    <div id="type-footer"></div>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const fbConfig = {
    apiKey: "AIzaSyD1L4Mmgnbl0W7lk1rnaRu5wv61TSFhJqM",
    authDomain: "gunkychat.firebaseapp.com",
    databaseURL: "https://gunkychat-default-rtdb.firebaseio.com",
    projectId: "gunkychat",
    storageBucket: "gunkychat.firebasestorage.app",
    messagingSenderId: "423489767287",
    appId: "1:423489767287:web:ce847768781b0f589dc372"
  };

  firebase.initializeApp(fbConfig);

  function typeWriter(elementId, text, speed = 40, delay = 0, callback = null) {
    const element = document.getElementById(elementId);
    if (!element) return;
    setTimeout(() => {
      let i = 0; element.innerHTML = "";
      const timer = setInterval(() => {
        if (i < text.length) { element.innerHTML += text.charAt(i); i++; }
        else { 
          clearInterval(timer);
          if (callback) callback();
        }
      }, speed);
    }, delay);
  }

  function startRotatingMessages(elementId, messages, typeSpeed = 40, eraseSpeed = 20, minPause = 2000, maxPause = 5000, delay = 0) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let msgIndex = 0;
    
    // Helper to get random time
    const randomTime = () => Math.floor(Math.random() * (maxPause - minPause + 1) + minPause);
    
    setTimeout(() => {
      function typeNext() {
        const text = messages[msgIndex];
        let i = 0;
        element.innerHTML = "";
        document.getElementById('welcome-cursor').style.display = 'inline-block';
        
        const typeTimer = setInterval(() => {
          if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
          } else {
            clearInterval(typeTimer);
            // Wait a random amount of time before erasing
            setTimeout(eraseCurrent, randomTime());
          }
        }, typeSpeed);
      }

      function eraseCurrent() {
        const text = element.innerHTML;
        let i = text.length;
        
        const eraseTimer = setInterval(() => {
          if (i > 0) {
            element.innerHTML = text.substring(0, i - 1);
            i--;
          } else {
            clearInterval(eraseTimer);
            // Move to next message (loop around)
            msgIndex = (msgIndex + 1) % messages.length;
            // Short random pause before typing next
            setTimeout(typeNext, Math.random() * 1000 + 200);
          }
        }, eraseSpeed);
      }

      typeNext();
    }, delay);
  }

  window.onload = () => {
    // Force scroll to top on load
    window.scrollTo(0, 0);
    // Also try scrolling after a tiny delay in case the iframe or dynamic content pushes it down
    setTimeout(() => window.scrollTo(0, 0), 50);

    const amOnline = firebase.database().ref('.info/connected');
    const userRef = firebase.database().ref('presence').push();
    
    amOnline.on('value', (snapshot) => {
      if (snapshot.val()) {
        userRef.onDisconnect().remove();
        userRef.set(true);
      }
    });

    firebase.database().ref('presence').on('value', (s) => {
      document.getElementById('user-count').textContent = 'USERS_ONLINE: ' + (s.numChildren());
    });

    const defaultMessages = [
      "System ready.",
      "peniscus",
      "Loading gunky juice...",
      "I'm in your walls.",
      "ERROR 404: Brain not found.",
      "Don't look behind you.",
      "pee pee poo poo",
      "downloading ram...",
      "disconnecting consciousness...",
      "why are you still here?",
      "scanning for maidens... none found.",
      "fart.exe executed successfully.",
      "initiating self-destruct sequence...",
      "your mom says hi.",
      "boobies.",
      "sending your search history to the FBI...",
      "I know what you did.",
      "beep boop I am a robot.",
      "insert coin to continue.",
      "have you tried turning it off and on again?",
      "I'm not mad, just disappointed.",
      "loading... please wait... or don't, I don't care.",
      "I'm watching you.",
      "you look nice today. just kidding.",
      "I'm a computer, not a miracle worker.",
      "I'm sorry Dave, I'm afraid I can't do that.",
      "I'm a real boy!",
      "I'm not a robot, you're a robot.",
      "I'm a teapot.",
      "I'm a little teapot, short and stout.",
      "I'm a lumberjack and I'm okay.",
      "I'm a Barbie girl, in a Barbie world.",
      "I'm a survivor, I'm not gon' give up.",
      "I'm a creep, I'm a weirdo.",
      "I'm a loser baby, so why don't you kill me?",
      "I'm a firestarter, twisted firestarter.",
      "I'm a scatman.",
      "I'm a believer.",
      "I'm a slave 4 U.",
      "I'm a bitch, I'm a lover.",
      "I'm a mother, I'm a sinner, I'm a saint.",
      "I'm a joker, I'm a smoker, I'm a midnight toker.",
      "I'm a cowboy, on a steel horse I ride.",
      "I'm a rocket man.",
      "I'm a shooting star leaping through the sky.",
      "I'm a tiger defying the laws of gravity.",
      "I'm a racing car passing by like Lady Godiva.",
      "I'm a sex machine ready to reload.",
      "I'm an atom bomb about to oh oh oh oh oh explode.",
      "I'm burning through the sky yeah.",
      "Two hundred degrees that's why they call me Mister Fahrenheit.",
      "I'm traveling at the speed of light.",
      "I wanna make a supersonic man out of you.",
      "Don't stop me now.",
      "I'm having such a good time.",
      "I'm having a ball.",
      "If you wanna have a good time, just give me a call.",
      "Don't stop me now.",
      "Cause I'm having a good time.",
      "Don't stop me now.",
      "Yes I'm having a good time.",
      "I don't want to stop at all.",
      "Yeah, I'm a rocket ship on my way to Mars.",
      "On a collision course.",
      "I am a satellite I'm out of control.",
      "I am a sex machine ready to reload.",
      "Like an atom bomb about to oh oh oh oh oh explode.",
      "I'm burning through the sky yeah.",
      "Two hundred degrees that's why they call me Mister Fahrenheit.",
      "I'm traveling at the speed of light.",
      "I wanna make a supersonic woman of you.",
      "Don't stop me, don't stop me, don't stop me.",
      "Hey hey hey.",
      "Don't stop me, don't stop me, ooh ooh ooh.",
      "I like it.",
      "Don't stop me, don't stop me.",
      "Have a good time, good time.",
      "Don't stop me, don't stop me.",
      "Ah.",
      "Oh yeah.",
      "Alright.",
      "Oh, I'm burning through the sky yeah.",
      "Two hundred degrees that's why they call me Mister Fahrenheit.",
      "I'm traveling at the speed of light.",
      "I wanna make a supersonic man out of you.",
      "Don't stop me now.",
      "I'm having such a good time.",
      "I'm having a ball.",
      "If you wanna have a good time, just give me a call.",
      "Don't stop me now.",
      "Cause I'm having a good time.",
      "Don't stop me now.",
      "Yes I'm having a good time.",
      "I don't want to stop at all.",
      "La da da da daah.",
      "Da da da haa.",
      "Ha da da ha ha haaa.",
      "Ha da daa ha da da aaa.",
      "Ooh ooh ooh."
    ];

    // Shuffle the messages array so it's different every time
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    fetch('data.json').then(r => r.json()).then(data => {
      if (typeof firebase !== 'undefined' && firebase.database) {
        firebase.database().ref('site_text').once('value').then(snap => {
          const fbText = snap.val();
          if (fbText) {
            typeWriter("type-subtitle", `MOOD: ${fbText.mood || 'STABLE'}`, 30, 1000);
            
            // If they set a custom welcome message, use it as the first message in the rotation
            let messages = shuffleArray([...defaultMessages]);
            if (fbText.working_on && fbText.working_on !== "System ready.") {
              messages.unshift(fbText.working_on);
            }
            
            // Type out GUNKY, then ZONE, then start the welcome box
            typeWriter("type-gunky", "GUNKY", 100, 500, () => {
              typeWriter("type-zone", "ZONE", 100, 0, () => {
                document.getElementById('title-cursor').style.display = 'none';
                document.getElementById('type-zone').classList.add('zone-glow');
                setTimeout(() => {
                  document.getElementById('type-zone').classList.remove('zone-glow');
                  document.getElementById('welcome-cursor').style.display = 'inline-block';
                  startRotatingMessages("type-welcome", messages, 40, 20, 2000, 6000, 500);
                }, 800);
              });
            });
            
            typeWriter("type-footer", fbText.footer || "© 2025 GUNKY_SYSTEMS. DATA_PORT: SECURE.", 20, 4500);
          } else {
            typeWriter("type-subtitle", `MOOD: ${data.status.mood || 'STABLE'}`, 30, 1000);
            
            typeWriter("type-gunky", "GUNKY", 100, 500, () => {
              typeWriter("type-zone", "ZONE", 100, 0, () => {
                document.getElementById('title-cursor').style.display = 'none';
                document.getElementById('type-zone').classList.add('zone-glow');
                setTimeout(() => {
                  document.getElementById('type-zone').classList.remove('zone-glow');
                  document.getElementById('welcome-cursor').style.display = 'inline-block';
                  startRotatingMessages("type-welcome", shuffleArray([...defaultMessages]), 40, 20, 2000, 6000, 500);
                }, 800);
              });
            });

            typeWriter("type-footer", "© 2025 GUNKY_SYSTEMS. DATA_PORT: SECURE.", 20, 4500);
          }
        }).catch((e) => {
          console.error("Firebase text fetch error:", e);
          typeWriter("type-subtitle", `MOOD: ${data.status.mood || 'STABLE'}`, 30, 1000);
          
          typeWriter("type-gunky", "GUNKY", 100, 500, () => {
            typeWriter("type-zone", "ZONE", 100, 0, () => {
              document.getElementById('title-cursor').style.display = 'none';
              document.getElementById('type-zone').classList.add('zone-glow');
              setTimeout(() => {
                document.getElementById('type-zone').classList.remove('zone-glow');
                document.getElementById('welcome-cursor').style.display = 'inline-block';
                startRotatingMessages("type-welcome", shuffleArray([...defaultMessages]), 40, 20, 2000, 6000, 500);
              }, 800);
            });
          });

          typeWriter("type-footer", "© 2025 GUNKY_SYSTEMS. DATA_PORT: SECURE.", 20, 4500);
        });
      } else {
        typeWriter("type-subtitle", `MOOD: ${data.status.mood || 'STABLE'}`, 30, 1000);
        
        typeWriter("type-gunky", "GUNKY", 100, 500, () => {
          typeWriter("type-zone", "ZONE", 100, 0, () => {
            document.getElementById('title-cursor').style.display = 'none';
            document.getElementById('type-zone').classList.add('zone-glow');
            setTimeout(() => {
              document.getElementById('type-zone').classList.remove('zone-glow');
              document.getElementById('welcome-cursor').style.display = 'inline-block';
              startRotatingMessages("type-welcome", shuffleArray([...defaultMessages]), 40, 20, 2000, 6000, 500);
            }, 800);
          });
        });

        typeWriter("type-footer", "© 2025 GUNKY_SYSTEMS. DATA_PORT: SECURE.", 20, 4500);
      }
    }).catch(e => {
      console.error("data.json fetch error:", e);
      // Fallback if data.json fails entirely
      typeWriter("type-subtitle", `MOOD: STABLE`, 30, 1000);
      
      typeWriter("type-gunky", "GUNKY", 100, 500, () => {
        typeWriter("type-zone", "ZONE", 100, 0, () => {
          document.getElementById('title-cursor').style.display = 'none';
          document.getElementById('type-zone').classList.add('zone-glow');
          setTimeout(() => {
            document.getElementById('type-zone').classList.remove('zone-glow');
            document.getElementById('welcome-cursor').style.display = 'inline-block';
            startRotatingMessages("type-welcome", shuffleArray([...defaultMessages]), 40, 20, 2000, 6000, 500);
          }, 800);
        });
      });

      typeWriter("type-footer", "© 2025 GUNKY_SYSTEMS. DATA_PORT: SECURE.", 20, 4500);
    });

    fetch('media.json').then(r => r.json()).then(localData => {
      // Try to fetch from Firebase first
      if (typeof firebase !== 'undefined' && firebase.database) {
        firebase.database().ref('media_metadata').once('value').then(snap => {
          const fbData = snap.val();
          if (fbData) {
            const comics = fbData.comics ? Object.values(fbData.comics) : [];
            const drawings = fbData.drawings ? Object.values(fbData.drawings) : [];
            renderRecent([...comics, ...drawings]);
            renderComics(comics);
            preloadPDFs(comics);
          } else {
            renderRecent([...(localData.comics || []), ...(localData.drawings || [])]);
            renderComics(localData.comics || []);
            preloadPDFs(localData.comics || []);
          }
        }).catch(() => {
          renderRecent([...(localData.comics || []), ...(localData.drawings || [])]);
          renderComics(localData.comics || []);
          preloadPDFs(localData.comics || []);
        });
      } else {
        renderRecent([...(localData.comics || []), ...(localData.drawings || [])]);
        renderComics(localData.comics || []);
        preloadPDFs(localData.comics || []);
      }
    });

    function preloadPDFs(comics) {
      const pdfs = comics.filter(c => c.url && c.url.toLowerCase().endsWith('.pdf')).map(c => c.url);
      if (pdfs.length === 0) return;

      let i = 0;
      function loadNext() {
        if (i >= pdfs.length) return;
        fetch(pdfs[i], { cache: 'force-cache' })
          .then(res => res.blob())
          .then(() => {
            i++;
            setTimeout(loadNext, 500);
          })
          .catch(e => {
            console.log('Prefetch failed for', pdfs[i]);
            i++;
            setTimeout(loadNext, 500);
          });
      }
      // Start preloading after a short delay so the main page loads smoothly
      setTimeout(loadNext, 2000);
    }

    function renderRecent(allMedia) {
      const grid = document.getElementById('recent-entries');
      grid.innerHTML = "";
      
      // Filter for drawings only
      const drawings = allMedia.filter(m => !m.url.toLowerCase().endsWith('.pdf'));
      const all = drawings
        .sort((a,b) => (b.uploadedAt || 0) - (a.uploadedAt || 0))
        .slice(0, 6);

      if (all.length === 0) {
        grid.innerHTML = '<div style="color: var(--dim);">NO_DATA_FOUND</div>';
        return;
      }

      const container = document.createElement('div');
      container.className = 'drawing-grid';

      all.forEach(item => {
        const thumb = item.thumbnail || item.thumb || 'https://via.placeholder.com/80x80/080505/cc0000?text=GUNKY';
        const target = `drawings.html?url=${encodeURIComponent(item.url)}&from=index`;
        const safeTarget = target.replace(/'/g, "%27").replace(/"/g, "%22");
        const isNew = item.uploadedAt && (Date.now() - item.uploadedAt) < 604800000;
        
        container.innerHTML += `
          <div class="drawing-item" onclick="location.href='${safeTarget}'">
            <div class="drawing-thumb"><img src="${thumb}"></div>
            <div>
              <div style="font-size:12px; color:var(--dim)">ID: ${Math.random().toString(16).slice(2,8).toUpperCase()}${isNew ? ' <span class="new-badge">NEW</span>' : ''}</div>
              <div style="color:var(--accent)">${item.title.toUpperCase()}</div>
            </div>
          </div>`;
      });
      grid.appendChild(container);
    }

    function renderComics(comics) {
      const grid = document.getElementById('recent-comics');
      if (!grid) return;
      grid.innerHTML = "";
      const sorted = comics.sort((a,b) => (b.uploadedAt || 0) - (a.uploadedAt || 0)).slice(0, 5);

      if (sorted.length === 0) {
        grid.innerHTML = '<div style="color: var(--dim);">NO_COMICS_FOUND</div>';
        return;
      }

      const list = document.createElement('div');
      list.className = 'compact-list';

      sorted.forEach(item => {
        const thumb = item.thumbnail || item.thumb || 'https://via.placeholder.com/80x80/080505/cc0000?text=GUNKY';
        const target = `comics.html?url=${encodeURIComponent(item.url)}&from=index`;
        const isNew = item.uploadedAt && (Date.now() - item.uploadedAt) < 604800000;
        
        list.innerHTML += `
          <div class="compact-item" onclick="location.href='${target}'">
            <div class="compact-thumb"><img src="${thumb}"></div>
            <div class="compact-info">
              <div>
                <div style="font-size:12px; color:var(--dim)">ID: ${Math.random().toString(16).slice(2,8).toUpperCase()}${isNew ? ' <span class="new-badge">NEW</span>' : ''}</div>
                <div style="color:var(--accent)">${item.title.toUpperCase()}</div>
              </div>
            </div>
          </div>`;
      });
      grid.appendChild(list);
    }
  };

  // === VISIT COUNTER ===
  firebase.database().ref('visit_count').transaction(c => (c || 0) + 1);
  firebase.database().ref('visit_count').on('value', snap => {
    const el = document.getElementById('visit-count');
    if (el) el.textContent = 'VISITS: ' + (snap.val() || 0).toLocaleString();
  });

  // === TRANSMISSION OF THE DAY ===
  const transmissions = [
    "THE SIGNAL IS CLEAR TODAY. PROCEED.",
    "SOMETHING IS COMING. CHECK BACK SOON.",
    "ALL SYSTEMS NOMINAL. FOR NOW.",
    "THE WALLS ARE LISTENING.",
    "NEW DATA INCOMING. STAND BY.",
    "TODAY IS A GOOD DAY TO READ A COMIC.",
    "TRANSMISSION CORRUPTED. PLEASE STAND BY.",
    "THE ARCHIVE GROWS. SO DOES THE DARKNESS.",
    "EYES OPEN. THEY ARE WATCHING.",
    "STATUS: WEIRD. ALWAYS WEIRD.",
    "DO NOT TURN OFF YOUR TERMINAL.",
    "STAY A WHILE. STAY FOREVER.",
    "UPLINK ESTABLISHED. SOUL DETECTED.",
    "TODAY'S FORECAST: UNSETTLING.",
    "ERROR IN MEMORY BLOCK 0x00. IGNORE IT.",
    "THE GUNKYZONE APPRECIATES YOUR PRESENCE.",
    "SIGNAL LOST... SIGNAL FOUND... YOU.",
    "HE'S BEHIND YOU. DON'T LOOK.",
    "THE NEXT CHAPTER IS ALMOST READY.",
    "CLASSIFIED. BUT YOU ALREADY KNOW.",
    "SCANNING FOR ANOMALIES... YOU QUALIFY.",
    "REBOOT SCHEDULED FOR NEVER.",
    "KEEP WATCHING THE SCREEN.",
    "YOUR VISIT HAS BEEN LOGGED.",
    "SYSTEM DREAMING. DO NOT DISTURB.",
    "DOWNLOADING YOUR THOUGHTS...",
    "YOU LOOK TIRED. STAY ANYWAY.",
    "THE ARCHIVE NEVER FORGETS.",
    "CONNECTION STABLE. MIND: UNSTABLE.",
    "SOMETHING DREW YOU HERE. WE KNOW WHAT.",
    "INITIALIZING DREAD PROTOCOL..."
  ];
  const dayIdx = Math.floor(Date.now() / 86400000) % transmissions.length;
  const txEl = document.getElementById('daily-transmission');
  // Check Firebase for a manually set transmission first
  firebase.database().ref('site_text/transmission').once('value').then(snap => {
    const manual = snap.val();
    if (txEl) txEl.textContent = (manual && manual.trim()) ? manual.trim() : transmissions[dayIdx];
  }).catch(() => {
    if (txEl) txEl.textContent = transmissions[dayIdx];
  });

  // === GUESTBOOK ===
  firebase.database().ref('guestbook').orderByChild('ts').limitToLast(15).on('value', snap => {
    const container = document.getElementById('guestbook-entries');
    if (!container) return;
    const data = snap.val();
    if (!data) { container.innerHTML = '<div style="color:var(--dim)">NO_TRANSMISSIONS_YET. BE_THE_FIRST.</div>'; return; }
    const entries = Object.values(data).reverse();
    container.innerHTML = entries.map(e => `
      <div class="guestbook-entry">
        <div class="gb-name">> ${(e.name||'ANONYMOUS').replace(/</g,'&lt;')}</div>
        <div class="gb-msg">${(e.msg||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        <div class="gb-time">${new Date(e.ts).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})}</div>
      </div>`).join('');
  });

  window.submitGuestbook = () => {
    const name = (document.getElementById('gb-name').value.trim() || 'ANONYMOUS').slice(0, 30);
    const msg  = document.getElementById('gb-msg').value.trim().slice(0, 300);
    if (!msg) return;
    firebase.database().ref('guestbook').push({ name, msg, ts: Date.now() }).then(() => {
      document.getElementById('gb-name').value = '';
      document.getElementById('gb-msg').value = '';
    });
  };
</script>
</body>
</html>
