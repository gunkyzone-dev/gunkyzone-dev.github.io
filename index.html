<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://accounts.google.com https://fonts.googleapis.com; script-src-elem 'self' https://www.gstatic.com https://apis.google.com https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' data: blob: https://*.googleapis.com https://www.googleapis.com https://www.gstatic.com https://accounts.google.com https://*.firebaseio.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.firebaseio.com; img-src 'self' data;">
  <title>GunkyZone</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #060606;
      --bg2:       #0d0d0d;
      --bg3:       #131313;
      --border:    #2a1a1a;
      --dim:       #5a3a3a;
      --text:      #d4c0c0;
      --accent:    #9b0000;
      --accent2:   #cc0000;
      --danger:    #cc0000;
      --glow:      rgba(155, 0, 0, 0.22);
      --font-mono: 'Share Tech Mono', monospace;
      --font-disp: 'VT323', monospace;
      --font-body: 'IM Fell English', serif;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 15px;
      line-height: 1.7;
      min-height: 100vh;
    }

    .site-wrapper {
      max-width: 960px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      overflow: hidden;
    }

    /* CRT overlay: static scanlines + vignette */
    .site-wrapper::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 30;
      background-image: repeating-linear-gradient(
        rgba(0,0,0,0.34) 0px,
        rgba(0,0,0,0.34) 3px,
        transparent 3px,
        transparent 9px
      );
      background-size: 100% 9px;
      mix-blend-mode: multiply;
      opacity: 0.98;
      animation: scanMove 6s linear infinite;
    }

    .site-wrapper::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 31;
      background: radial-gradient(
        ellipse at center,
        rgba(255,255,255,0) 0%,
        rgba(0,0,0,0) 55%,
        rgba(0,0,0,0.36) 100%
      );
      mix-blend-mode: multiply;
      opacity: 0.9;
    }

    @keyframes scanMove {
      from { background-position: 0 0; }
      to { background-position: 0 9px; }
    }

    header {
      border-bottom: 1px solid var(--border);
      padding: 28px 0 18px;
    }

    .site-title {
      font-family: var(--font-disp);
      font-size: clamp(52px, 9vw, 90px);
      line-height: 1;
      color: var(--accent);
      text-shadow: 0 0 40px var(--glow), 0 0 80px rgba(212,168,67,0.08);
      letter-spacing: 2px;
    }

    .site-title span {
      color: var(--accent2);
    }

    .site-subtitle {
      font-family: var(--font-body);
      font-style: italic;
      color: var(--dim);
      font-size: 14px;
      margin-top: 10px;
    }

    /* blinking cursor */
    .cursor {
      display: inline-block;
      width: 2px;
      height: 0.85em;
      background: var(--accent);
      vertical-align: middle;
      margin-left: 4px;
      animation: blink 1.1s step-end infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      display: flex;
      gap: 0;
      margin-top: 28px;
      border: 1px solid var(--border);
      width: fit-content;
    }

    nav a {
      display: block;
      padding: 7px 18px;
      color: var(--dim);
      font-size: 13px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      text-decoration: none;
      border-right: 1px solid var(--border);
      transition: all 0.15s;
    }
    nav a:last-child { border-right: none; }
    nav a:hover {
      background: var(--bg3);
      color: var(--accent);
      text-decoration: none;
    }
    nav a.active {
      background: var(--bg3);
      color: var(--accent);
    }

    /* â”€â”€â”€ MAIN GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      display: grid;
      grid-template-columns: 1fr 260px;
      gap: 24px;
      margin-top: 32px;
    }

    @media (max-width: 640px) {
      main { grid-template-columns: 1fr; }
      .sidebar { border-left: none; border-top: 1px solid var(--border); }
    }

    /* â”€â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-label {
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--dim);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* â”€â”€â”€ WELCOME BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-col {
      padding-right: 40px;
      padding-bottom: 60px;
    }

    .welcome-box {
      border: 1px solid var(--border);
      padding: 24px 28px;
      background: linear-gradient(180deg, var(--bg2), #0b0b0b);
      margin-bottom: 36px;
      position: relative;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      border-radius: 6px;
    }
    .welcome-box::before {
      content: '//';
      position: absolute;
      top: -1px; left: 16px;
      background: var(--bg2);
      padding: 0 6px;
      font-size: 11px;
      color: var(--accent);
    }
    .welcome-box p {
      font-family: var(--font-body);
      font-size: 15px;
      color: var(--text);
      line-height: 1.9;
    }

    /* â”€â”€â”€ CHAT ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-room {
      border: 1px solid var(--border);
      background: var(--bg2);
      padding: 14px;
      border-radius: 6px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.3);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
    }

    .chat-title {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
    }

    .chat-messages {
      background: var(--bg3);
      border: 1px solid var(--border);
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-size: 13px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: var(--bg);
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--dim);
    }

    .chat-msg {
      margin-bottom: 10px;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-msg.msg-sent {
      animation: msgPop 0.6s cubic-bezier(0.16, 0.84, 0.24, 1) both;
    }

    @keyframes msgPop {
      from { transform: translateY(10px) scale(0.994); opacity: 0; }
      60% { transform: translateY(-1px) scale(1.001); opacity: 1; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .chat-author {
      color: var(--accent2);
      font-size: 12px;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-ts {
      color: var(--dim);
      font-size: 11px;
      font-weight: 400;
    }

    .chat-text {
      color: var(--text);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.45;
      margin-top: 6px;
      word-wrap: break-word;
    }

    .chat-form {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chat-form input[type="text"] {
      padding: 8px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text);
      font-family: var(--font-mono);
      border-radius: 4px;
      transition: border-color 0.2s;
    }

    .chat-form input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }

    #chat-name {
      width: 120px;
    }

    #chat-text {
      flex: 1;
      min-width: 200px;
    }

    .chat-form input[type="submit"] {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--accent);
      cursor: pointer;
      font-family: var(--font-mono);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .chat-form input[type="submit"]:hover {
      background: var(--accent);
      color: var(--bg);
    }

    /* Delete button styling */
    .chat-delete-btn {
      background: transparent;
      border: none;
      color: var(--dim);
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      margin-left: 4px;
      opacity: 0.6;
      transition: opacity 0.2s, color 0.2s;
    }

    .chat-delete-btn:hover {
      opacity: 1;
      color: var(--danger);
    }

    /* Admin button */
    #chat-admin-btn {
      background: transparent;
      border: none;
      color: var(--dim);
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      width: 24px;
      height: 24px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    #chat-admin-btn:hover {
      opacity: 1;
    }

    /* Admin panel */
    #chat-admin-panel {
      position: absolute;
      right: 8px;
      top: 36px;
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      z-index: 9999;
      min-width: 240px;
    }

    .admin-panel-title {
      font-size: 13px;
      margin-bottom: 10px;
      color: var(--dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .admin-btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 12px;
      transition: all 0.2s;
    }

    .admin-btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .admin-btn-primary:hover {
      background: var(--accent2);
    }

    .admin-btn-google {
      background: #4285F4;
      color: #fff;
    }

    .admin-btn-google:hover {
      background: #357ae8;
    }

    .admin-input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin-bottom: 8px;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      border-radius: 4px;
    }

    .admin-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .admin-note {
      font-size: 11px;
      color: var(--dim);
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Color picker */
    #chat-color-btn {
      width: 40px;
      height: 36px;
      padding: 0;
      border: 1px solid var(--border);
      background: var(--bg3);
      cursor: pointer;
      border-radius: 4px;
      transition: border-color 0.2s;
    }

    #chat-color-btn:hover {
      border-color: var(--accent);
    }

    #chat-color-swatch {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 3px;
    }

    #chat-color-popup {
      position: absolute;
      left: 0;
      top: 44px;
      z-index: 20;
    }

    .color-popup-inner {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      min-width: 220px;
    }

    .color-swatches {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .swatch {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    .color-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #chat-color-native {
      width: 50px;
      height: 36px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg3);
      cursor: pointer;
    }

    .sidebar {
      border-left: 1px solid var(--border);
      padding-left: 24px;
    }

    .note {
      font-size: 12px;
      color: var(--dim);
      margin-top: 12px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="site-wrapper">
    <header>
      <h1 class="site-title">GUNKY<span>ZONE</span></h1>
      <p class="site-subtitle">a dark corner of the web<span class="cursor"></span></p>
      <nav>
        <a href="index.html" class="active">home</a>
        <a href="comics.html">comics</a>
        <a href="anecdotes.html">anecdotes</a>
        <a href="chat.html">chat</a>
        <a href="about.html">about</a>
      </nav>
    </header>

    <main>
      <div class="main-col">
        <div class="welcome-box">
          <p>
            Welcome to the GunkyZone. This is a personal site where I share my thoughts, 
            creations, and the weird stuff I find interesting. Feel free to explore, 
            drop a message in the chat, or just lurk around.
          </p>
        </div>

        <div class="section-label">Live Chat</div>
        <div class="chat-room" id="chat-room">
          <div class="chat-header">
            <div class="chat-title">~ messages ~</div>
          </div>
          <div class="chat-messages" id="chat-messages" aria-live="polite"></div>
          <form id="chat-form" class="chat-form">
            <div style="position: relative;">
              <button type="button" id="chat-color-btn" title="Choose name color">
                <span id="chat-color-swatch" style="background: #cc0000;"></span>
              </button>
              <div id="chat-color-popup" style="display: none;">
                <div class="color-popup-inner">
                  <div class="color-swatches">
                    <button type="button" class="swatch" data-color="#cc0000" style="background: #cc0000;"></button>
                    <button type="button" class="swatch" data-color="#ff8a00" style="background: #ff8a00;"></button>
                    <button type="button" class="swatch" data-color="#ffd166" style="background: #ffd166;"></button>
                    <button type="button" class="swatch" data-color="#8affc1" style="background: #8affc1;"></button>
                    <button type="button" class="swatch" data-color="#66b2ff" style="background: #66b2ff;"></button>
                    <button type="button" class="swatch" data-color="#d39bff" style="background: #d39bff;"></button>
                  </div>
                  <div class="color-controls">
                    <input id="chat-color-native" type="color" value="#cc0000">
                    <button type="button" id="chat-color-close" class="admin-btn admin-btn-primary" style="margin: 0;">Done</button>
                  </div>
                </div>
              </div>
            </div>
            <input type="text" id="chat-name" placeholder="name" maxlength="24" aria-label="Your name">
            <input type="text" id="chat-text" placeholder="say somethingâ€¦" aria-label="Your message">
            <input type="submit" value="send">
          </form>
          <p class="note">Messages are stored in Firebase Realtime Database and visible to all visitors.</p>
        </div>
      </div>

      <aside class="sidebar">
        <div class="section-label">Info</div>
        <p style="font-size: 13px; line-height: 1.6;">
          This site is a work in progress. More content coming soon. The chat uses Firebase for real-time messaging.
        </p>
      </aside>
    </main>
  </div>

  <!-- Load Firebase config and admin config -->
  <script src="firebase-config.js"></script>
  <script src="chat-admin.js"></script>

  <script>
  (function(){
    'use strict';

    var KEY = 'gunky_chat_msgs';
    var MAX = 200;
    
    var messagesEl = document.getElementById('chat-messages');
    var form = document.getElementById('chat-form');
    var nameIn = document.getElementById('chat-name');
    var textIn = document.getElementById('chat-text');
    var colorNative = document.getElementById('chat-color-native');
    var colorBtn = document.getElementById('chat-color-btn');
    var colorPopup = document.getElementById('chat-color-popup');
    var colorSwatch = document.getElementById('chat-color-swatch');
    var colorClose = document.getElementById('chat-color-close');
    
    var firebaseRef = null;
    var adminBtn = null;
    var currentUser = null;
    var isAdmin = (localStorage.getItem('gunky_chat_is_admin') === '1');
    var adminConf = window.CHAT_ADMIN || null;
    var lastSentTs = null;
    var FORCE_LOCAL = (localStorage.getItem('gunky_chat_force_local') === '1');

    var DEFAULT_COLOR = '#cc0000';

    function safeParse(v) {
      try { return JSON.parse(v || '[]'); }
      catch(e) { return []; }
    }

    function loadLocal() {
      return safeParse(localStorage.getItem(KEY));
    }

    function saveLocal(msgs) {
      try { localStorage.setItem(KEY, JSON.stringify(msgs)); }
      catch(e) { console.warn('localStorage save failed', e); }
    }

    function renderMessages(msgs) {
      messagesEl.innerHTML = '';
      
      msgs.forEach(function(m) {
        // Skip deleted messages
        if (m.deleted) return;

        var wrap = document.createElement('div');
        wrap.className = 'chat-msg';
        
        var author = document.createElement('div');
        author.className = 'chat-author';
        author.textContent = m.author || 'anon';
        
        var ts = document.createElement('span');
        ts.className = 'chat-ts';
        ts.textContent = new Date(m.ts || Date.now()).toLocaleTimeString();
        author.appendChild(ts);
        
        var savedColor = localStorage.getItem('gunky_chat_name_color') || DEFAULT_COLOR;
        author.style.color = m.color || savedColor;
        
        // Add delete button for admins
        if (isAdmin) {
          var delBtn = document.createElement('button');
          delBtn.className = 'chat-delete-btn';
          delBtn.textContent = 'Ã—';
          delBtn.title = 'Delete message';
          delBtn.addEventListener('click', function() {
            handleDelete(m);
          });
          author.appendChild(delBtn);
        }
        
        var text = document.createElement('div');
        text.className = 'chat-text';
        text.textContent = m.text || '';
        
        wrap.appendChild(author);
        wrap.appendChild(text);
        
        // Highlight newly sent message
        if (lastSentTs && m.ts === lastSentTs) {
          wrap.classList.add('msg-sent');
          setTimeout(function() { lastSentTs = null; }, 1600);
        }
        
        messagesEl.appendChild(wrap);
      });
      
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function handleDelete(msg) {
      if (!confirm('Delete this message?')) return;
      
      if (msg._key && firebaseRef) {
        // Firebase delete
        firebaseRef.child(msg._key).remove()
          .then(function() {
            console.log('Message deleted');
          })
          .catch(function(err) {
            console.error('Delete failed:', err);
            alert('Failed to delete message: ' + err.message);
          });
      } else {
        // Local delete
        var msgsLocal = loadLocal();
        var idx = msgsLocal.findIndex(function(mm) {
          return mm.ts === msg.ts && mm.author === msg.author && mm.text === msg.text;
        });
        if (idx > -1) {
          msgsLocal.splice(idx, 1);
          saveLocal(msgsLocal);
          renderMessages(msgsLocal);
        }
      }
    }

    // Color picker setup
    if (colorBtn && colorPopup && colorNative && colorSwatch && colorClose) {
      colorBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        colorPopup.style.display = (colorPopup.style.display === 'block') ? 'none' : 'block';
      });

      colorPopup.querySelectorAll('.swatch').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var c = btn.getAttribute('data-color');
          colorNative.value = c;
          colorSwatch.style.background = c;
          try { localStorage.setItem('gunky_chat_name_color', c); } catch(e) {}
        });
      });

      colorNative.addEventListener('input', function() {
        colorSwatch.style.background = colorNative.value;
        try { localStorage.setItem('gunky_chat_name_color', colorNative.value); } catch(e) {}
      });

      colorClose.addEventListener('click', function() {
        colorPopup.style.display = 'none';
      });

      document.addEventListener('click', function(e) {
        if (!colorPopup.contains(e.target) && e.target !== colorBtn) {
          colorPopup.style.display = 'none';
        }
      });

      // Restore saved color
      var savedColor = localStorage.getItem('gunky_chat_name_color');
      if (savedColor) {
        colorNative.value = savedColor;
        colorSwatch.style.background = savedColor;
      }
    }

    // Admin button setup: add buttons to both chat header and top site header
    function createAdminButton() {
      var chatHeader = document.querySelector('#chat-room .chat-header');
      var topHeader = document.querySelector('header');

      function makeBtn(id) {
        var btn = document.createElement('button');
        btn.id = id || 'chat-admin-btn';
        btn.title = isAdmin ? 'Admin: sign out' : 'Admin: sign in';
        btn.innerHTML = 'â‹¯';
        btn.addEventListener('click', toggleAdminPanel);
        return btn;
      }

      if (chatHeader) {
        var btn1 = makeBtn('chat-admin-btn');
        chatHeader.appendChild(btn1);
        adminBtn = btn1;
      }

      if (topHeader) {
        var btnTop = makeBtn('chat-admin-btn-top');
        topHeader.appendChild(btnTop);
      }
    }

    // Add a small toggle to force local-only mode (useful when Firebase/CSP blocked)
    function createLocalToggle() {
      var header = document.querySelector('#chat-room .chat-header') || document.querySelector('header');
      if (!header) return;
      if (document.getElementById('chat-local-toggle')) return;

      var btn = document.createElement('button');
      btn.id = 'chat-local-toggle';
      btn.className = 'admin-btn';
      btn.style.padding = '6px 8px';
      btn.style.fontSize = '12px';
      btn.textContent = FORCE_LOCAL ? 'Local: ON' : 'Local: OFF';
      btn.title = 'Toggle local-only chat (no Firebase)';
      btn.addEventListener('click', function() {
        var enabled = !(localStorage.getItem('gunky_chat_force_local') === '1');
        if (enabled) localStorage.setItem('gunky_chat_force_local', '1');
        else localStorage.removeItem('gunky_chat_force_local');
        alert('Local-only mode ' + (enabled ? 'enabled' : 'disabled') + '. Reloading...');
        location.reload();
      });

      header.appendChild(btn);
    }

    function toggleAdminPanel() {
      if (isAdmin) {
        // Sign out
        if (window.firebase && firebase.auth) {
          firebase.auth().signOut().catch(function() {});
        }
        isAdmin = false;
        localStorage.removeItem('gunky_chat_is_admin');
        var topBtn = document.getElementById('chat-admin-btn-top');
        if (adminBtn) adminBtn.title = 'Admin: sign in';
        if (topBtn) topBtn.title = 'Admin: sign in';
        renderMessages(loadLocal());
        return;
      }

      if (!(window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey)) {
        alert('Firebase config required for admin sign-in');
        return;
      }

      showAdminPanel();
    }

    function showAdminPanel() {
      var header = document.querySelector('#chat-room .chat-header');
      if (!header) return;

      var panel = document.getElementById('chat-admin-panel');
      
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'chat-admin-panel';
        panel.innerHTML =
          '<div class="admin-panel-title">Admin Sign In</div>' +
          '<button id="chat-admin-google" class="admin-btn admin-btn-google">Sign in with Google</button>' +
          '<div id="chat-admin-fallback">' +
            '<input id="chat-admin-email" class="admin-input" placeholder="Email" type="email">' +
            '<input id="chat-admin-pw" class="admin-input" type="password" placeholder="Password">' +
            '<button id="chat-admin-email-btn" class="admin-btn admin-btn-primary">Sign in with Email</button>' +
          '</div>' +
          '<div class="admin-note">Admin access requires Firebase Authentication.</div>';
        
        header.appendChild(panel);
        setupAdminPanelHandlers(panel);
      } else {
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
      }
    }

    function setupAdminPanelHandlers(panel) {
      var googleBtn = panel.querySelector('#chat-admin-google');
      var emailBtn = panel.querySelector('#chat-admin-email-btn');
      var emailIn = panel.querySelector('#chat-admin-email');
      var pwIn = panel.querySelector('#chat-admin-pw');

      function handleAuth(cred) {
        var user = cred.user;
        
        if (window.CHAT_ADMIN && 
            Array.isArray(window.CHAT_ADMIN.adminUIDs) && 
            window.CHAT_ADMIN.adminUIDs.indexOf(user.uid) !== -1) {
          
          isAdmin = true;
          localStorage.setItem('gunky_chat_is_admin', '1');
          var topBtn = document.getElementById('chat-admin-btn-top');
          if (adminBtn) adminBtn.title = 'Admin: sign out';
          if (topBtn) topBtn.title = 'Admin: sign out';
          
          alert('Admin mode enabled!');
          panel.style.display = 'none';
          renderMessages(loadLocal());
        } else {
          firebase.auth().signOut().catch(function() {});
          alert('Not authorized as admin. Your UID: ' + user.uid);
        }
      }

      googleBtn.addEventListener('click', function() {
        if (window.firebase && firebase.auth && firebase.auth().signInWithPopup) {
          var provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().signInWithPopup(provider)
            .then(handleAuth)
            .catch(function(err) {
              console.warn('Google sign-in failed', err);
              alert('Google sign-in failed: ' + (err && err.message));
            });
        } else {
          alert('Google sign-in not available');
        }
      });

      emailBtn.addEventListener('click', function() {
        var email = (emailIn.value || '').trim();
        var pw = (pwIn.value || '').trim();
        
        if (!email || !pw) {
          alert('Please enter email and password');
          return;
        }
        
        firebase.auth().signInWithEmailAndPassword(email, pw)
          .then(handleAuth)
          .catch(function(err) {
            console.warn('Email sign-in failed', err);
            alert('Sign-in failed: ' + (err && err.message));
          });
      });
    }

    // Initialize
    createAdminButton();
    createLocalToggle();

    // Local-only mode (fallback)
    function enableLocalMode() {
      console.info('Chat: using localStorage fallback');
      renderMessages(loadLocal());
    }

    // Firebase initialization (skipped when forced local)
    if (!FORCE_LOCAL && window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.databaseURL) {
      function loadScript(src, cb) {
        var s = document.createElement('script');
        s.src = src;
        s.onload = cb;
        s.onerror = function() {
          console.error('Failed to load script:', src);
          enableLocalMode();
        };
        document.head.appendChild(s);
      }

      loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js', function() {
        loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js', function() {
          loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js', function() {
            try {
              firebase.initializeApp(window.FIREBASE_CONFIG);
              
              // Auth state listener
              firebase.auth().onAuthStateChanged(function(user) {
                currentUser = user;
                
                if (user && 
                    window.CHAT_ADMIN && 
                    Array.isArray(window.CHAT_ADMIN.adminUIDs) && 
                    window.CHAT_ADMIN.adminUIDs.indexOf(user.uid) !== -1) {
                  
                  isAdmin = true;
                  localStorage.setItem('gunky_chat_is_admin', '1');
                  var topBtn = document.getElementById('chat-admin-btn-top');
                  if (adminBtn) adminBtn.title = 'Admin: sign out';
                  if (topBtn) topBtn.title = 'Admin: sign out';
                  console.info('Chat: admin authenticated', user.uid);
                } else {
                  isAdmin = false;
                  localStorage.removeItem('gunky_chat_is_admin');
                  var topBtn = document.getElementById('chat-admin-btn-top');
                  if (adminBtn) adminBtn.title = 'Admin: sign in';
                  if (topBtn) topBtn.title = 'Admin: sign in';
                }
                
                renderMessages(loadLocal());
              });

              // Database listener
              firebaseRef = firebase.database().ref('/gunky_chat');
              
              firebaseRef.on('value', function(snap) {
                var raw = snap.val() || {};
                var list = [];
                
                if (Array.isArray(raw)) {
                  list = raw.map(function(v, i) {
                    v._key = i;
                    return v;
                  });
                } else {
                  list = Object.keys(raw).map(function(k) {
                    var v = raw[k];
                    v._key = k;
                    return v;
                  });
                }
                
                // Save to localStorage
                try {
                  var plain = list.map(function(m) {
                    var o = Object.assign({}, m);
                    delete o._key;
                    return o;
                  });
                  localStorage.setItem(KEY, JSON.stringify(plain));
                } catch(e) {
                  console.warn('localStorage save failed', e);
                }
                
                renderMessages(list);
              });

              console.info('Chat: Firebase realtime enabled');
              
            } catch(err) {
              console.warn('Chat: firebase init error', err);
              enableLocalMode();
            }
          });
        });
      });
    } else {
      enableLocalMode();
    }

    // Form submit handler
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      var name = (nameIn.value || '').trim() || 'anon';
      var text = (textIn.value || '').trim();
      var chosenColor = (colorNative && colorNative.value) || 
                       (localStorage.getItem('gunky_chat_name_color') || DEFAULT_COLOR);
      
      try {
        localStorage.setItem('gunky_chat_name_color', chosenColor);
      } catch(e) {}
      
      if (!text) return;
      
      var tsVal = Date.now();
      lastSentTs = tsVal;
      
      if (firebaseRef) {
        // Firebase mode
        try {
          firebaseRef.push({
            author: name,
            text: text,
            ts: tsVal,
            color: chosenColor
          });
          textIn.value = '';
        } catch(e) {
          console.warn('Chat: firebase write failed', e);
          alert('Failed to send message: ' + e.message);
        }
      } else {
        // Local mode
        var msgs = loadLocal();
        msgs.push({
          author: name,
          text: text,
          ts: tsVal,
          color: chosenColor
        });
        
        if (msgs.length > MAX) {
          msgs.splice(0, msgs.length - MAX);
        }
        
        saveLocal(msgs);
        textIn.value = '';
        renderMessages(msgs);
      }
    });

  })();
  </script>
</body>
</html>
